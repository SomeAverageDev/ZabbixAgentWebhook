<?xml version="1.0" encoding="UTF-8"?>
<zabbix_export>
    <version>5.0</version>
    <date>2022-03-26T18:39:31Z</date>
    <groups>
        <group>
            <name>Templates</name>
        </group>
    </groups>
    <templates>
        <template>
            <template>CMS_ZBX_WEBHOOK_TPL</template>
            <name>CMS_ZBX_WEBHOOK_TPL</name>
            <groups>
                <group>
                    <name>Templates</name>
                </group>
            </groups>
            <applications>
                <application>
                    <name>AWS</name>
                </application>
                <application>
                    <name>Azure</name>
                </application>
                <application>
                    <name>webhook</name>
                </application>
                <application>
                    <name>Zabbix</name>
                </application>
            </applications>
            <items>
                <item>
                    <name>Zabbix webhook json data trapper : aws-sns</name>
                    <type>TRAP</type>
                    <key>aws-sns</key>
                    <delay>0</delay>
                    <history>1h</history>
                    <trends>0</trends>
                    <value_type>TEXT</value_type>
                    <applications>
                        <application>
                            <name>AWS</name>
                        </application>
                        <application>
                            <name>webhook</name>
                        </application>
                    </applications>
                </item>
                <item>
                    <name>aws-sns decoded message</name>
                    <type>DEPENDENT</type>
                    <key>aws-sns[decoded]</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <trends>0</trends>
                    <value_type>TEXT</value_type>
                    <applications>
                        <application>
                            <name>AWS</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JAVASCRIPT</type>
                            <params>var data = JSON.parse(value); 
return 'Message['+ data.Timestamp +']: '+ data.Subject +': '+ data.Message +' on topic:'+ data.TopicArn</params>
                        </step>
                        <step>
                            <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                            <params>300</params>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>aws-sns</key>
                    </master_item>
                    <triggers>
                        <trigger>
                            <expression>{strlen()}&gt;0</expression>
                            <recovery_mode>NONE</recovery_mode>
                            <name>AWS-SNS {ITEM.LASTVALUE}</name>
                            <priority>WARNING</priority>
                            <type>MULTIPLE</type>
                            <manual_close>YES</manual_close>
                        </trigger>
                    </triggers>
                </item>
                <item>
                    <name>Zabbix webhook json data trapper : azure-monitor</name>
                    <type>TRAP</type>
                    <key>az-mon</key>
                    <delay>0</delay>
                    <history>1h</history>
                    <trends>0</trends>
                    <value_type>TEXT</value_type>
                    <applications>
                        <application>
                            <name>Azure</name>
                        </application>
                        <application>
                            <name>webhook</name>
                        </application>
                    </applications>
                </item>
                <item>
                    <name>azure-monitor decoded message</name>
                    <type>DEPENDENT</type>
                    <key>az-mon[decoded]</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <trends>0</trends>
                    <value_type>TEXT</value_type>
                    <applications>
                        <application>
                            <name>Azure</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JAVASCRIPT</type>
                            <params>var data = JSON.parse(value); 
return 'Message['+ data.data.essentials.firedDateTime +']: '+ data.data.essentials.alertRule +': '+ data.data.essentials.severity+' on topic:'+ data.data.essentials.configurationItems.join(', ')</params>
                        </step>
                        <step>
                            <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                            <params>300</params>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>az-mon</key>
                    </master_item>
                    <triggers>
                        <trigger>
                            <expression>{strlen()}&gt;0</expression>
                            <recovery_mode>NONE</recovery_mode>
                            <name>AZ-MON {ITEM.LASTVALUE}</name>
                            <priority>WARNING</priority>
                            <type>MULTIPLE</type>
                            <manual_close>YES</manual_close>
                        </trigger>
                    </triggers>
                </item>
                <item>
                    <name>Zabbix webhook json data trapper : generic</name>
                    <type>TRAP</type>
                    <key>webhook</key>
                    <delay>0</delay>
                    <history>1h</history>
                    <trends>0</trends>
                    <value_type>TEXT</value_type>
                    <applications>
                        <application>
                            <name>webhook</name>
                        </application>
                    </applications>
                </item>
                <item>
                    <name>Zabbix webhook container health on http://{$ZBX_WHK_HOST}:{$ZBX_WHK_PORT}/health</name>
                    <type>HTTP_AGENT</type>
                    <key>webhook.countainer.health[{$ZBX_WHK_HOST},{$ZBX_WHK_PORT}]</key>
                    <history>30d</history>
                    <trends>0</trends>
                    <value_type>TEXT</value_type>
                    <applications>
                        <application>
                            <name>webhook</name>
                        </application>
                        <application>
                            <name>Zabbix</name>
                        </application>
                    </applications>
                    <timeout>10s</timeout>
                    <url>http://{$ZBX_WHK_HOST}:{$ZBX_WHK_PORT}/health</url>
                    <triggers>
                        <trigger>
                            <expression>{nodata(10m)}=1</expression>
                            <name>Zabbix webhook container health has no data since 10m</name>
                            <priority>WARNING</priority>
                            <manual_close>YES</manual_close>
                            <dependencies>
                                <dependency>
                                    <name>Zabbix webhook container health has no data since 20m</name>
                                    <expression>{CMS_ZBX_WEBHOOK_TPL:webhook.countainer.health[{$ZBX_WHK_HOST},{$ZBX_WHK_PORT}].nodata(20m)}=1</expression>
                                </dependency>
                            </dependencies>
                        </trigger>
                        <trigger>
                            <expression>{nodata(20m)}=1</expression>
                            <name>Zabbix webhook container health has no data since 20m</name>
                            <priority>HIGH</priority>
                            <manual_close>YES</manual_close>
                        </trigger>
                    </triggers>
                </item>
            </items>
            <discovery_rules>
                <discovery_rule>
                    <name>aws-sns message discovery</name>
                    <type>DEPENDENT</type>
                    <key>aws-sns[discovery]</key>
                    <delay>0</delay>
                    <status>DISABLED</status>
                    <item_prototypes>
                        <item_prototype>
                            <name>aws-sns message : {#ID}</name>
                            <type>DEPENDENT</type>
                            <key>aws-sns[{#ID}]</key>
                            <delay>0</delay>
                            <trends>0</trends>
                            <value_type>TEXT</value_type>
                            <applications>
                                <application>
                                    <name>AWS</name>
                                </application>
                            </applications>
                            <master_item>
                                <key>aws-sns</key>
                            </master_item>
                        </item_prototype>
                    </item_prototypes>
                    <master_item>
                        <key>aws-sns</key>
                    </master_item>
                    <lld_macro_paths>
                        <lld_macro_path>
                            <lld_macro>{#ID}</lld_macro>
                            <path>$.MessageId</path>
                        </lld_macro_path>
                        <lld_macro_path>
                            <lld_macro>{#MESSAGE}</lld_macro>
                            <path>$.Message</path>
                        </lld_macro_path>
                        <lld_macro_path>
                            <lld_macro>{#SUBJECT}</lld_macro>
                            <path>$.Subject</path>
                        </lld_macro_path>
                        <lld_macro_path>
                            <lld_macro>{#TIMESTAMP}</lld_macro>
                            <path>*.Timestamp</path>
                        </lld_macro_path>
                        <lld_macro_path>
                            <lld_macro>{#TOPIC}</lld_macro>
                            <path>$.TopicArn</path>
                        </lld_macro_path>
                    </lld_macro_paths>
                </discovery_rule>
            </discovery_rules>
            <macros>
                <macro>
                    <macro>{$ZBX_WHK_HOST}</macro>
                    <value>localhost</value>
                </macro>
                <macro>
                    <macro>{$ZBX_WHK_PORT}</macro>
                    <value>80</value>
                </macro>
            </macros>
        </template>
    </templates>
</zabbix_export>
