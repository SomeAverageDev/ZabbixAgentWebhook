<?xml version="1.0" encoding="UTF-8"?>
<zabbix_export>
    <version>5.0</version>
    <date>2022-04-17T20:44:48Z</date>
    <groups>
        <group>
            <name>Templates</name>
        </group>
    </groups>
    <templates>
        <template>
            <template>CMS_ZBX_WEBHOOK_TPL</template>
            <name>CMS_ZBX_WEBHOOK_TPL</name>
            <groups>
                <group>
                    <name>Templates</name>
                </group>
            </groups>
            <applications>
                <application>
                    <name>AWS</name>
                </application>
                <application>
                    <name>Azure</name>
                </application>
                <application>
                    <name>GCP</name>
                </application>
                <application>
                    <name>webhook</name>
                </application>
                <application>
                    <name>Zabbix</name>
                </application>
            </applications>
            <items>
                <item>
                    <name>Zabbix webhook json data trapper : aws-sns</name>
                    <type>TRAP</type>
                    <key>aws-sns</key>
                    <delay>0</delay>
                    <history>1h</history>
                    <trends>0</trends>
                    <value_type>TEXT</value_type>
                    <applications>
                        <application>
                            <name>AWS</name>
                        </application>
                        <application>
                            <name>webhook</name>
                        </application>
                    </applications>
                </item>
                <item>
                    <name>aws-sns decoded message</name>
                    <type>DEPENDENT</type>
                    <key>aws-sns[decoded]</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <trends>0</trends>
                    <status>DISABLED</status>
                    <value_type>TEXT</value_type>
                    <applications>
                        <application>
                            <name>AWS</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JAVASCRIPT</type>
                            <params>var data = JSON.parse(value); 
return 'Message['+ data.Timestamp +']: '+ data.Subject +': '+ data.Message +' on topic:'+ data.TopicArn</params>
                        </step>
                        <step>
                            <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                            <params>300</params>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>aws-sns</key>
                    </master_item>
                    <triggers>
                        <trigger>
                            <expression>{strlen()}&gt;0</expression>
                            <recovery_mode>NONE</recovery_mode>
                            <name>AWS-SNS {ITEM.LASTVALUE}</name>
                            <priority>WARNING</priority>
                            <type>MULTIPLE</type>
                            <manual_close>YES</manual_close>
                        </trigger>
                    </triggers>
                </item>
                <item>
                    <name>Zabbix webhook json data trapper : azure-monitor</name>
                    <type>TRAP</type>
                    <key>az-mon</key>
                    <delay>0</delay>
                    <history>1h</history>
                    <trends>0</trends>
                    <value_type>TEXT</value_type>
                    <applications>
                        <application>
                            <name>Azure</name>
                        </application>
                        <application>
                            <name>webhook</name>
                        </application>
                    </applications>
                </item>
                <item>
                    <name>azure-monitor decoded alert</name>
                    <type>DEPENDENT</type>
                    <key>az-mon[decode]</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <trends>0</trends>
                    <status>DISABLED</status>
                    <value_type>TEXT</value_type>
                    <applications>
                        <application>
                            <name>Azure</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JAVASCRIPT</type>
                            <params>var data = JSON.parse(value);
if (data.schemaId.localeCompare('azureMonitorCommonAlertSchema') == 0) {
  return 'Message['+ data.data.essentials.firedDateTime +']: '+ data.data.essentials.alertRule +': '+ data.data.essentials.severity+' on topic:'+ data.data.essentials.configurationItems.join(', ')
}
return 'unknown azure format:'+JSON.stringify(data)
</params>
                        </step>
                        <step>
                            <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                            <params>300</params>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>az-mon</key>
                    </master_item>
                    <triggers>
                        <trigger>
                            <expression>{strlen()}&gt;0</expression>
                            <recovery_mode>NONE</recovery_mode>
                            <name>AZ-MON {ITEM.LASTVALUE}</name>
                            <priority>WARNING</priority>
                            <type>MULTIPLE</type>
                            <manual_close>YES</manual_close>
                        </trigger>
                    </triggers>
                </item>
                <item>
                    <name>Zabbix webhook json data trapper : gcp</name>
                    <type>TRAP</type>
                    <key>gcp</key>
                    <delay>0</delay>
                    <history>1h</history>
                    <trends>0</trends>
                    <value_type>TEXT</value_type>
                    <applications>
                        <application>
                            <name>GCP</name>
                        </application>
                        <application>
                            <name>webhook</name>
                        </application>
                    </applications>
                </item>
                <item>
                    <name>Zabbix webhook json data trapper : generic</name>
                    <type>TRAP</type>
                    <key>webhook</key>
                    <delay>0</delay>
                    <history>1h</history>
                    <trends>0</trends>
                    <value_type>TEXT</value_type>
                    <applications>
                        <application>
                            <name>webhook</name>
                        </application>
                    </applications>
                </item>
                <item>
                    <name>Zabbix webhook container health on {$ZBX_WHK_PROTO}://{$ZBX_WHK_HOST}:{$ZBX_WHK_PORT}/health</name>
                    <type>HTTP_AGENT</type>
                    <key>webhook.countainer.health[{$ZBX_WHK_HOST},{$ZBX_WHK_PORT}]</key>
                    <history>30d</history>
                    <trends>0</trends>
                    <value_type>TEXT</value_type>
                    <applications>
                        <application>
                            <name>webhook</name>
                        </application>
                        <application>
                            <name>Zabbix</name>
                        </application>
                    </applications>
                    <timeout>10s</timeout>
                    <url>{$ZBX_WHK_PROTO}://{$ZBX_WHK_HOST}:{$ZBX_WHK_PORT}/health</url>
                    <triggers>
                        <trigger>
                            <expression>{nodata(15m)}=1</expression>
                            <name>Zabbix webhook container health has no data since 15m</name>
                            <priority>WARNING</priority>
                            <manual_close>YES</manual_close>
                            <dependencies>
                                <dependency>
                                    <name>Zabbix webhook container health has no data since 30m</name>
                                    <expression>{CMS_ZBX_WEBHOOK_TPL:webhook.countainer.health[{$ZBX_WHK_HOST},{$ZBX_WHK_PORT}].nodata(30m)}=1</expression>
                                </dependency>
                            </dependencies>
                        </trigger>
                        <trigger>
                            <expression>{nodata(30m)}=1</expression>
                            <name>Zabbix webhook container health has no data since 30m</name>
                            <priority>HIGH</priority>
                            <manual_close>YES</manual_close>
                        </trigger>
                    </triggers>
                </item>
            </items>
            <discovery_rules>
                <discovery_rule>
                    <name>aws-sns message discovery</name>
                    <type>DEPENDENT</type>
                    <key>aws-sns[discovery]</key>
                    <delay>0</delay>
                    <status>DISABLED</status>
                    <item_prototypes>
                        <item_prototype>
                            <name>aws-sns message : {#ID}</name>
                            <type>DEPENDENT</type>
                            <key>aws-sns[{#ID}]</key>
                            <delay>0</delay>
                            <trends>0</trends>
                            <value_type>TEXT</value_type>
                            <applications>
                                <application>
                                    <name>AWS</name>
                                </application>
                            </applications>
                            <master_item>
                                <key>aws-sns</key>
                            </master_item>
                        </item_prototype>
                    </item_prototypes>
                    <master_item>
                        <key>aws-sns</key>
                    </master_item>
                    <lld_macro_paths>
                        <lld_macro_path>
                            <lld_macro>{#ID}</lld_macro>
                            <path>$.MessageId</path>
                        </lld_macro_path>
                        <lld_macro_path>
                            <lld_macro>{#MESSAGE}</lld_macro>
                            <path>$.Message</path>
                        </lld_macro_path>
                        <lld_macro_path>
                            <lld_macro>{#SUBJECT}</lld_macro>
                            <path>$.Subject</path>
                        </lld_macro_path>
                        <lld_macro_path>
                            <lld_macro>{#TIMESTAMP}</lld_macro>
                            <path>*.Timestamp</path>
                        </lld_macro_path>
                        <lld_macro_path>
                            <lld_macro>{#TOPIC}</lld_macro>
                            <path>$.TopicArn</path>
                        </lld_macro_path>
                    </lld_macro_paths>
                </discovery_rule>
                <discovery_rule>
                    <name>Azure monitor alerts discovery</name>
                    <type>DEPENDENT</type>
                    <key>azure.alerts[discovery]</key>
                    <delay>0</delay>
                    <lifetime>7d</lifetime>
                    <item_prototypes>
                        <item_prototype>
                            <name>Azure Alert state [{#ID}]</name>
                            <type>DEPENDENT</type>
                            <key>az.alert.state[{#ID}]</key>
                            <delay>0</delay>
                            <history>7d</history>
                            <trends>0</trends>
                            <value_type>TEXT</value_type>
                            <applications>
                                <application>
                                    <name>Azure</name>
                                </application>
                            </applications>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$.data.essentials.monitorCondition</params>
                                    <error_handler>DISCARD_VALUE</error_handler>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>az-mon</key>
                            </master_item>
                        </item_prototype>
                        <item_prototype>
                            <name>Azure Alert summary [{#ID}]</name>
                            <type>DEPENDENT</type>
                            <key>az.alert.summary[{#ID}]</key>
                            <delay>0</delay>
                            <history>7d</history>
                            <trends>0</trends>
                            <value_type>TEXT</value_type>
                            <applications>
                                <application>
                                    <name>Azure</name>
                                </application>
                            </applications>
                            <preprocessing>
                                <step>
                                    <type>NOT_MATCHES_REGEX</type>
                                    <params>&quot;monitorCondition&quot;:&quot;Resolved&quot;,</params>
                                    <error_handler>DISCARD_VALUE</error_handler>
                                </step>
                                <step>
                                    <type>JAVASCRIPT</type>
                                    <params>var data = JSON.parse(value);
if (data.schemaId.localeCompare('azureMonitorCommonAlertSchema') == 0) {
  msg = 'Message['+ data.data.essentials.firedDateTime +']: '+ data.data.essentials.alertRule +': '+ data.data.essentials.severity
  if (typeof data.data.essentials.configurationItems !== 'undefined') {
    msg = msg + ' on topic:' + data.data.essentials.configurationItems.join(', ')
  }
  return msg
}
return 'unknown azure format:'+JSON.stringify(data)
</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>az-mon</key>
                            </master_item>
                        </item_prototype>
                    </item_prototypes>
                    <trigger_prototypes>
                        <trigger_prototype>
                            <expression>{CMS_ZBX_WEBHOOK_TPL:az.alert.summary[{#ID}].str(Sev0)}=1 and&#13;
{CMS_ZBX_WEBHOOK_TPL:az.alert.state[{#ID}].str(Resolved)}=0</expression>
                            <recovery_mode>RECOVERY_EXPRESSION</recovery_mode>
                            <recovery_expression>{CMS_ZBX_WEBHOOK_TPL:az.alert.state[{#ID}].str(Resolved)}=1</recovery_expression>
                            <name>Azure alerts:{ITEM.VALUE}</name>
                            <priority>HIGH</priority>
                            <manual_close>YES</manual_close>
                        </trigger_prototype>
                        <trigger_prototype>
                            <expression>{CMS_ZBX_WEBHOOK_TPL:az.alert.summary[{#ID}].str(Sev1)}=1 and&#13;
{CMS_ZBX_WEBHOOK_TPL:az.alert.state[{#ID}].str(Resolved)}=0</expression>
                            <recovery_mode>RECOVERY_EXPRESSION</recovery_mode>
                            <recovery_expression>{CMS_ZBX_WEBHOOK_TPL:az.alert.state[{#ID}].str(Resolved)}=1</recovery_expression>
                            <name>Azure alerts:{ITEM.VALUE}</name>
                            <priority>AVERAGE</priority>
                            <manual_close>YES</manual_close>
                        </trigger_prototype>
                        <trigger_prototype>
                            <expression>{CMS_ZBX_WEBHOOK_TPL:az.alert.summary[{#ID}].str(Sev2)}=1 and&#13;
{CMS_ZBX_WEBHOOK_TPL:az.alert.state[{#ID}].str(Resolved)}=0</expression>
                            <recovery_mode>RECOVERY_EXPRESSION</recovery_mode>
                            <recovery_expression>{CMS_ZBX_WEBHOOK_TPL:az.alert.state[{#ID}].str(Resolved)}=1</recovery_expression>
                            <name>Azure alerts:{ITEM.VALUE}</name>
                            <priority>WARNING</priority>
                            <manual_close>YES</manual_close>
                        </trigger_prototype>
                        <trigger_prototype>
                            <expression>{CMS_ZBX_WEBHOOK_TPL:az.alert.summary[{#ID}].str(Sev4)}=1 and&#13;
{CMS_ZBX_WEBHOOK_TPL:az.alert.state[{#ID}].str(Resolved)}=0</expression>
                            <recovery_mode>RECOVERY_EXPRESSION</recovery_mode>
                            <recovery_expression>{CMS_ZBX_WEBHOOK_TPL:az.alert.state[{#ID}].str(Resolved)}=1</recovery_expression>
                            <name>Azure alerts:{ITEM.VALUE}</name>
                            <priority>INFO</priority>
                            <manual_close>YES</manual_close>
                        </trigger_prototype>
                    </trigger_prototypes>
                    <master_item>
                        <key>az-mon</key>
                    </master_item>
                    <lld_macro_paths>
                        <lld_macro_path>
                            <lld_macro>{#ID}</lld_macro>
                            <path>$.essentials.originAlertId</path>
                        </lld_macro_path>
                        <lld_macro_path>
                            <lld_macro>{#RULE}</lld_macro>
                            <path>$.essentials.alertRule</path>
                        </lld_macro_path>
                        <lld_macro_path>
                            <lld_macro>{#STATE}</lld_macro>
                            <path>$.essentials.monitorCondition</path>
                        </lld_macro_path>
                    </lld_macro_paths>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$.data</params>
                            <error_handler>DISCARD_VALUE</error_handler>
                        </step>
                        <step>
                            <type>JAVASCRIPT</type>
                            <params>return '['+value+']'</params>
                        </step>
                    </preprocessing>
                </discovery_rule>
                <discovery_rule>
                    <name>GCP messages discovery</name>
                    <type>DEPENDENT</type>
                    <key>gcp.messages[discovery]</key>
                    <delay>0</delay>
                    <lifetime>7d</lifetime>
                    <item_prototypes>
                        <item_prototype>
                            <name>GCP Alert state [{#ID}]</name>
                            <type>DEPENDENT</type>
                            <key>gcp.state[{#ID}]</key>
                            <delay>0</delay>
                            <history>7d</history>
                            <trends>0</trends>
                            <value_type>TEXT</value_type>
                            <applications>
                                <application>
                                    <name>GCP</name>
                                </application>
                            </applications>
                            <application_prototypes>
                                <application_prototype>
                                    <name>{#PROJECTID}</name>
                                </application_prototype>
                            </application_prototypes>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$.incident.state</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>gcp</key>
                            </master_item>
                        </item_prototype>
                        <item_prototype>
                            <name>GCP Alert summary [{#ID}]</name>
                            <type>DEPENDENT</type>
                            <key>gcp.summary[{#ID}]</key>
                            <delay>0</delay>
                            <history>7d</history>
                            <trends>0</trends>
                            <value_type>TEXT</value_type>
                            <applications>
                                <application>
                                    <name>GCP</name>
                                </application>
                            </applications>
                            <application_prototypes>
                                <application_prototype>
                                    <name>{#PROJECTID}</name>
                                </application_prototype>
                            </application_prototypes>
                            <preprocessing>
                                <step>
                                    <type>NOT_MATCHES_REGEX</type>
                                    <params>&quot;closed&quot;,</params>
                                    <error_handler>DISCARD_VALUE</error_handler>
                                </step>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$.incident.summary</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>gcp</key>
                            </master_item>
                        </item_prototype>
                    </item_prototypes>
                    <trigger_prototypes>
                        <trigger_prototype>
                            <expression>{CMS_ZBX_WEBHOOK_TPL:gcp.summary[{#ID}].strlen()}&gt;0 and &#13;
{CMS_ZBX_WEBHOOK_TPL:gcp.state[{#ID}].str(closed)}=0</expression>
                            <recovery_mode>RECOVERY_EXPRESSION</recovery_mode>
                            <recovery_expression>{CMS_ZBX_WEBHOOK_TPL:gcp.state[{#ID}].str(closed)}=1</recovery_expression>
                            <name>GCP Alert:{ITEM.VALUE1}</name>
                            <priority>AVERAGE</priority>
                            <manual_close>YES</manual_close>
                        </trigger_prototype>
                    </trigger_prototypes>
                    <master_item>
                        <key>gcp</key>
                    </master_item>
                    <lld_macro_paths>
                        <lld_macro_path>
                            <lld_macro>{#ID}</lld_macro>
                            <path>$.incident.incident_id</path>
                        </lld_macro_path>
                        <lld_macro_path>
                            <lld_macro>{#POLICY}</lld_macro>
                            <path>$.incident.policy_name</path>
                        </lld_macro_path>
                        <lld_macro_path>
                            <lld_macro>{#PROJECTID}</lld_macro>
                            <path>$.incident.resource.labels.project_id</path>
                        </lld_macro_path>
                        <lld_macro_path>
                            <lld_macro>{#STATE}</lld_macro>
                            <path>$.incident.state</path>
                        </lld_macro_path>
                        <lld_macro_path>
                            <lld_macro>{#SUMMARY}</lld_macro>
                            <path>$.incident.summary</path>
                        </lld_macro_path>
                    </lld_macro_paths>
                    <preprocessing>
                        <step>
                            <type>JAVASCRIPT</type>
                            <params>return '['+value+']'</params>
                        </step>
                    </preprocessing>
                </discovery_rule>
            </discovery_rules>
            <macros>
                <macro>
                    <macro>{$ZBX_WHK_HOST}</macro>
                    <value>localhost</value>
                </macro>
                <macro>
                    <macro>{$ZBX_WHK_PORT}</macro>
                    <value>80</value>
                </macro>
                <macro>
                    <macro>{$ZBX_WHK_PROTO}</macro>
                    <value>http</value>
                </macro>
            </macros>
        </template>
    </templates>
</zabbix_export>
